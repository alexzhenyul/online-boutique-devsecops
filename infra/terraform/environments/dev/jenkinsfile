pipeline {
    agent any

    parameters {
        string(name: 'repoUrl', defaultValue: 'https://github.com/alexzhenyul/online-boutique-devsecops.git', description: 'Git repository URL')
        choice(name: 'environment', choices: ['dev', 'staging', 'prod'], description: 'Select the environment to deploy')
        choice(name: 'target', choices: ['foundation', 'addons', 'both'], description: 'Which layer to deploy')
        booleanParam(name: 'skipSecurityChecks', defaultValue: false, description: 'Skip security scanning (not recommended)')
        string(name: 'emailRecipients', defaultValue: 'your-real-email@gmail.com', description: 'Email recipients (comma separated)')
    }

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION    = 'ap-southeast-4'
        FOUNDATION_DIR        = "infra/terraform/environments/${params.environment}/foundation"
        ADDONS_DIR            = "infra/terraform/environments/${params.environment}/addons"
    }

    stages {

        // ─────────────────────────────────────────
        // STAGE 1: Checkout
        // ─────────────────────────────────────────
        stage('Checkout') {
            steps {
                git branch: 'main', url: params.repoUrl
                sh """
                    echo "Repo:        ${params.repoUrl}"
                    echo "Commit:      \$(git rev-parse --short HEAD)"
                    echo "Environment: ${params.environment}"
                    echo "Target:      ${params.target}"
                """
            }
        }

        // ─────────────────────────────────────────
        // STAGE 2: Security Scan - tfsec
        // ─────────────────────────────────────────
        stage('Security Scan - tfsec') {
            when {
                expression { params.skipSecurityChecks == false }
            }
            steps {
                sh """
                    echo "Running tfsec on ${params.environment} environment..."

                    echo "====== TFSEC SECURITY SCAN REPORT ======" > tfsec-report.txt
                    echo "Environment: ${params.environment}" >> tfsec-report.txt
                    echo "Date: \$(date)" >> tfsec-report.txt
                    echo "" >> tfsec-report.txt

                    tfsec infra/terraform/environments/${params.environment}/ \
                        --format csv \
                        --minimum-severity MEDIUM \
                        --soft-fail >> tfsec-report.txt || true

                    echo "" >> tfsec-report.txt
                    echo "====== END OF REPORT ======" >> tfsec-report.txt

                    cat tfsec-report.txt
                """
                archiveArtifacts artifacts: 'tfsec-report.txt'
            }
        }

        // ─────────────────────────────────────────
        // STAGE 3: Quality Gate
        // ─────────────────────────────────────────
        stage('Quality Gate') {
            when {
                expression { params.skipSecurityChecks == false }
            }
            steps {
                script {
                    echo "Checking Quality Gate..."

                    def criticalCount = sh(
                        script: "grep -i ',CRITICAL,' tfsec-report.txt | wc -l || echo 0",
                        returnStdout: true
                    ).trim().toInteger()

                    def highCount = sh(
                        script: "grep -i ',HIGH,' tfsec-report.txt | wc -l || echo 0",
                        returnStdout: true
                    ).trim().toInteger()

                    def mediumCount = sh(
                        script: "grep -i ',MEDIUM,' tfsec-report.txt | wc -l || echo 0",
                        returnStdout: true
                    ).trim().toInteger()

                    env.CRITICAL_COUNT      = criticalCount.toString()
                    env.HIGH_COUNT          = highCount.toString()
                    env.MEDIUM_COUNT        = mediumCount.toString()

                    echo """
====== QUALITY GATE SUMMARY ======
CRITICAL : ${criticalCount}
HIGH     : ${highCount}
MEDIUM   : ${mediumCount}
===================================
                    """

                    if (criticalCount > 0) {
                        env.QUALITY_GATE_STATUS = 'FAILED'
                        error """
Quality Gate FAILED!
Found ${criticalCount} CRITICAL security issue(s).
Please review tfsec-report.txt and fix all CRITICAL issues before deploying.
                        """
                    } else {
                        env.QUALITY_GATE_STATUS = 'PASSED'
                        echo "Quality Gate PASSED! No CRITICAL issues found."
                        echo "HIGH: ${highCount} | MEDIUM: ${mediumCount} — review recommended but not blocking."
                    }
                }
            }
        }

        // ─────────────────────────────────────────
        // STAGE 4: Terraform Init - Foundation
        // ─────────────────────────────────────────
        stage('Init - Foundation') {
            when {
                expression { params.target in ['foundation', 'both'] }
            }
            steps {
                sh """
                    echo "Initializing Foundation for ${params.environment}..."
                    cd ${FOUNDATION_DIR}
                    terraform init -reconfigure
                """
            }
        }

        // ─────────────────────────────────────────
        // STAGE 5: Terraform Validate - Foundation
        // ─────────────────────────────────────────
        stage('Validate - Foundation') {
            when {
                expression { params.target in ['foundation', 'both'] }
            }
            steps {
                sh """
                    echo "Validating Foundation for ${params.environment}..."
                    cd ${FOUNDATION_DIR}
                    terraform validate
                    echo "Validation passed!"
                """
            }
        }

        // ─────────────────────────────────────────
        // STAGE 6: Terraform Plan - Foundation
        // ─────────────────────────────────────────
        stage('Plan - Foundation') {
            when {
                expression { params.target in ['foundation', 'both'] }
            }
            steps {
                sh """
                    echo "Planning Foundation for ${params.environment}..."
                    cd ${FOUNDATION_DIR}
                    terraform plan -out=tfplan
                    terraform show -no-color tfplan > tfplan-foundation.txt
                """
                archiveArtifacts artifacts: "${FOUNDATION_DIR}/tfplan-foundation.txt"
            }
        }

        // ─────────────────────────────────────────
        // STAGE 7: Terraform Init - Addons
        // ─────────────────────────────────────────
        stage('Init - Addons') {
            when {
                expression { params.target in ['addons', 'both'] }
            }
            steps {
                sh """
                    echo "Initializing Addons for ${params.environment}..."
                    cd ${ADDONS_DIR}
                    terraform init -reconfigure
                """
            }
        }

        // ─────────────────────────────────────────
        // STAGE 8: Terraform Validate - Addons
        // ─────────────────────────────────────────
        stage('Validate - Addons') {
            when {
                expression { params.target in ['addons', 'both'] }
            }
            steps {
                sh """
                    echo "Validating Addons for ${params.environment}..."
                    cd ${ADDONS_DIR}
                    terraform validate
                    echo "Validation passed!"
                """
            }
        }

        // ─────────────────────────────────────────
        // STAGE 9: Terraform Plan - Addons
        // ─────────────────────────────────────────
        stage('Plan - Addons') {
            when {
                expression { params.target in ['addons', 'both'] }
            }
            steps {
                sh """
                    echo "Planning Addons for ${params.environment}..."
                    cd ${ADDONS_DIR}
                    terraform plan -out=tfplan \
                        -var="tf_state_bucket=devsecops-platform-template"
                    terraform show -no-color tfplan > tfplan-addons.txt
                """
                archiveArtifacts artifacts: "${ADDONS_DIR}/tfplan-addons.txt"
            }
        }
    }

    // ─────────────────────────────────────────
    // POST ACTIONS
    // ─────────────────────────────────────────
    post {
        success {
            echo "Pipeline completed successfully for [${params.environment}]!"
            emailext(
                to: params.emailRecipients,
                subject: "✅ [SUCCESS] Terraform Pipeline - ${params.environment} - Build #${BUILD_NUMBER}",
                mimeType: 'text/html',
                attachmentsPattern: 'tfsec-report.txt, **/tfplan-foundation.txt, **/tfplan-addons.txt',
                body: """
                    <html>
                    <body>
                        <h2 style="color:green;">✅ Pipeline SUCCESS</h2>
                        <table border="1" cellpadding="5" cellspacing="0">
                            <tr><td><b>Environment</b></td><td>${params.environment}</td></tr>
                            <tr><td><b>Target</b></td><td>${params.target}</td></tr>
                            <tr><td><b>Build</b></td><td>#${BUILD_NUMBER}</td></tr>
                            <tr><td><b>Repo</b></td><td>${params.repoUrl}</td></tr>
                            <tr><td><b>Build URL</b></td><td><a href="${BUILD_URL}">${BUILD_URL}</a></td></tr>
                        </table>

                        <h3>Security Scan Results</h3>
                        <table border="1" cellpadding="5" cellspacing="0">
                            <tr><td><b>Quality Gate</b></td><td style="color:green;"><b>${env.QUALITY_GATE_STATUS ?: 'SKIPPED'}</b></td></tr>
                            <tr><td><b>CRITICAL</b></td><td style="color:red;">${env.CRITICAL_COUNT ?: '0'}</td></tr>
                            <tr><td><b>HIGH</b></td><td style="color:orange;">${env.HIGH_COUNT ?: '0'}</td></tr>
                            <tr><td><b>MEDIUM</b></td><td style="color:blue;">${env.MEDIUM_COUNT ?: '0'}</td></tr>
                        </table>

                        <p>Please review the attached reports before applying.</p>
                    </body>
                    </html>
                """
            )
            cleanWs()
        }
        failure {
            echo "Pipeline failed for [${params.environment}]!"
            emailext(
                to: params.emailRecipients,
                subject: "❌ [FAILED] Terraform Pipeline - ${params.environment} - Build #${BUILD_NUMBER}",
                mimeType: 'text/html',
                attachmentsPattern: 'tfsec-report.txt',
                body: """
                    <html>
                    <body>
                        <h2 style="color:red;">❌ Pipeline FAILED</h2>
                        <table border="1" cellpadding="5" cellspacing="0">
                            <tr><td><b>Environment</b></td><td>${params.environment}</td></tr>
                            <tr><td><b>Target</b></td><td>${params.target}</td></tr>
                            <tr><td><b>Build</b></td><td>#${BUILD_NUMBER}</td></tr>
                            <tr><td><b>Repo</b></td><td>${params.repoUrl}</td></tr>
                            <tr><td><b>Build URL</b></td><td><a href="${BUILD_URL}">${BUILD_URL}</a></td></tr>
                        </table>

                        <h3>Security Scan Results</h3>
                        <table border="1" cellpadding="5" cellspacing="0">
                            <tr><td><b>Quality Gate</b></td><td style="color:red;"><b>${env.QUALITY_GATE_STATUS ?: 'SKIPPED'}</b></td></tr>
                            <tr><td><b>CRITICAL</b></td><td style="color:red;">${env.CRITICAL_COUNT ?: '0'}</td></tr>
                            <tr><td><b>HIGH</b></td><td style="color:orange;">${env.HIGH_COUNT ?: '0'}</td></tr>
                            <tr><td><b>MEDIUM</b></td><td style="color:blue;">${env.MEDIUM_COUNT ?: '0'}</td></tr>
                        </table>

                        <p style="color:red;"><b>Pipeline failed — check Jenkins console for details.</b></p>
                        <p>Common causes: Quality Gate blocked by CRITICAL issues, Terraform errors, or AWS credential issues.</p>
                    </body>
                    </html>
                """
            )
            cleanWs()
        }
    }
}